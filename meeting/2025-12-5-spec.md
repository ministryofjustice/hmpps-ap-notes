# API Endpoints Specification - Accommodation Service

## Overview

This document defines the API endpoints for the Single Accommodation Service (SAS) frontend integration. It establishes an initial contract between the backend and frontend.

**Date Format**: All dates will be SQL DateTime format (ISO 8601: `YYYY-MM-DDTHH:mm:ss.sssZ`).

All endpoints are keyed by CRN (e.g., `X123456`), and each GET endpoint will supply this value as a path parameter.

The following endpoints are required:

1. **Profile** - Person profile information
2. **DTR** - Return all Duty to Refer records
3. **CAS Status** - Community Accommodation pending applications
4. **Private Addresses** - List of private addresses with their status
5. **Actions** - Actions and prompts available on the screen
6. **Current and Next Address** - Current and upcoming accommodation details
7. **Referral History** - Historical record of referrals

---

## 1. Profile Endpoint

**Endpoint**: `GET /sas/{crn}/profile`

**Description**: Returns person profile information for the specified CRN.

**Response**:
```json
{
  "crn": "X123456",
  "fullName": "John Smith",
  "roshRating": "High",
  "tier": "A",
  "prisonNumber": "A1234BC",
  "pncReference": "PNC123456",
  "dateOfBirth": "1985-05-15T00:00:00.000Z",
  "assignedTo": {
    "id": "user-123",
    "name": "Jane Doe",
    "isCurrentUser": false
  }
}
```

**Field Descriptions**:
- `fullName` - Full name of the person
- `roshRating` - Risk of Serious Harm rating (displayed as tag)
- `tier` - Tier classification (displayed as tag)
- `prisonNumber` - Prison number identifier
- `pncReference` - Police National Computer reference
- `dateOfBirth` - Date of birth in ISO 8601 format
- `assignedTo` - Person assigned to the case
  - `isCurrentUser` - Boolean indicating if the assigned person is the signed-in user
  - If `isCurrentUser` is `true`, the frontend should display as "You (Firstname Lastname)"
  - If `isCurrentUser` is `false`, display as "Firstname Lastname"

**Related**: [SAS-78](https://dsdmoj.atlassian.net/browse/SAS-78)

---

## 2. Duty to Refer (DTR) Endpoint

**Endpoint**: `GET /sas/{crn}/dtrs`

**Description**: Returns all Duty to Refer records for the specified CRN.

**Response**:
```json
[
  {
    "id": "dtr-12345",
    "crn": "X123456",
    "submittedTo": "Cherwell District Council",
    "reference": "DTR-2025-001234",
    "submitted": "2025-11-30T10:30:00.000Z",
    "status": "submitted",
    "outcome": "pending"
  }
]
```

**Assumptions**:
- Multiple DTRs cannot be submitted in parallel for a CRN at one time
- This list will at most have one pending or submitted DTR
- The response or request does not consider the event ID(s). The event ID(s) will tie the person to a particular series of offences. On a long enough timeline with multiple incarcerations for different events, you would expect the DTR process to reset.

---

## 3. CAS Status Endpoint

**Endpoint**: `GET /sas/{crn}/cas-eligibility`

**Description**: Returns Community Accommodation Service eligibility status for CAS1, CAS2, and CAS3.

**Response**:
```json
{
  "crn": "X123456",
  "cas1": {
    "eligible": true,
    "status": "not_applied",
    "currentAssignment": null
  },
  "cas2": {
    "eligible": true,
    "status": "not_applied",
    "currentAssignment": null
  },
  "cas3": {
    "eligible": true,
    "status": "active",
    "currentApplication": {
      "id": "cas3-001",
      "startDate": "2025-11-01T00:00:00.000Z",
      "addedBy": "person-id"
    }
  }
}
```

---

## 4. Private Addresses Endpoint

**Endpoint**: `GET /sas/{crn}/private-addresses`

**Description**: Returns a list of private addresses with their status for the specified CRN.

**Response**:
```json
{
  "crn": "X123456",
  "addresses": [
    {
      "id": "addr-001",
      "status": "not_checked",
      "address": {
        "line1": "Flat 2",
        "line2": "14 Fallowbank Road",
        "region": "Oxford",
        "city": "Oxford",
        "postcode": "OX2 6ZZ"
      },
      "addedBy": {
        "id": "user-123",
        "name": "Sam Carter",
        "role": "Prison Admin"
      },
      "addedDate": "2025-11-30T08:00:00.000Z"
    },
    {
      "id": "addr-002",
      "status": "proposed",
      "address": {
        "line1": "Room 5",
        "line2": "22 High Street",
        "region": "Oxford",
        "city": "Oxford",
        "postcode": "OX1 4AB"
      },
      "addedBy": {
        "id": "user-456",
        "name": "Jane Smith",
        "role": "Probation Officer"
      },
      "addedDate": "2025-11-28T12:00:00.000Z"
    }
  ]
}
```

---

## 5. Actions Endpoint

**Endpoint**: `GET /sas/{crn}/actions`

**Description**: Returns actions and prompts available on the screen for the specified CRN.

**Response**:
```json
[
  {
    "id": "rule-001",
    "outcome": true,
    "advice": "any advice, or not supplied"
  }
]
```

---

## 6. Current and Next Address Endpoint

**Endpoint**: `GET /sas/{crn}/accommodation`

**Description**: Returns current and upcoming accommodation details for the specified CRN.

**Response**:
```json
{
  "crn": "X123456",
  "current": {
    "id": "acc-001",
    "type": "CAS3",
    "startDate": "2025-11-01T00:00:00.000Z",
    "endDate": "2025-12-13T00:00:00.000Z",
    "daysRemaining": 10,
    "status": "active",
    "address": {
      "line1": "Room 3 Willow Court",
      "line2": "7 Meadowbank Drive",
      "region": "Summertown",
      "city": "Oxford",
      "postcode": "OX2 9ZZ"
    }
  },
  "next": {
    "id": "acc-002",
    "type": "CAS2",
    "startDate": "2025-12-14T00:00:00.000Z",
    "endDate": "2026-01-14T00:00:00.000Z",
    "daysUntilStart": 11,
    "status": "confirmed",
    "address": {
      "line1": "Room 3 Willow Court",
      "line2": "7 Meadowbank Drive",
      "region": "Summertown",
      "city": "Oxford",
      "postcode": "OX2 9ZZ"
    }
  }
}
```

---

## 7. Referral History Endpoint

**Endpoint**: `GET /sas/{crn}/referral-history`

**Description**: Returns historical record of referrals for the specified CRN.

**Response**:
```json
{
  "referrals": [
    {
      "type": "CAS1",
      "referralId": "string",
      "status": "accepted",
      "date": "2025-12-14T00:00:00.000Z"
    }
  ]
}
```

**Field Descriptions**:
- `type` - Referral type: `"CAS1"`, `"CAS2"`, `"CAS2v2"`, or `"CAS3"`
- `status` - Referral status: `"accepted"`, `"rejected"`, or `"pending"`

**Related**: [SAS-83](https://dsdmoj.atlassian.net/browse/SAS-83)
